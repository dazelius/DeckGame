<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gore VFX Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a2e;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #444;
        }
        
        .controls h2 {
            margin-bottom: 15px;
            color: #ff4444;
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        button {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        .btn-blood {
            background: linear-gradient(135deg, #8b0000, #dc143c);
            color: white;
        }
        
        .btn-slash {
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            color: white;
        }
        
        .btn-dismember {
            background: linear-gradient(135deg, #4a0000, #8b0000);
            color: white;
        }
        
        .btn-explode {
            background: linear-gradient(135deg, #ff0000, #ff4444);
            color: white;
        }
        
        .test-target {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .test-target img {
            width: 150px;
            height: auto;
            image-rendering: pixelated;
        }
        
        .test-target .label {
            margin-top: 10px;
            padding: 5px 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            font-size: 14px;
        }
        
        .log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 3px 0;
            padding: 3px 5px;
        }
        
        .log-entry.error {
            color: #ff6b6b;
        }
        
        .log-entry.success {
            color: #4ade80;
        }
        
        .log-entry.info {
            color: #60a5fa;
        }
        
        #vfx-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        
        @keyframes goreFlash {
            0% { opacity: 0.6; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <canvas id="vfx-canvas"></canvas>
    
    <div class="controls">
        <h2>ğŸ©¸ Gore VFX Test</h2>
        <div class="btn-group">
            <button class="btn-blood" onclick="testBloodSplatter()">ğŸ’§ í”¼ íŠ€ê¹€</button>
            <button class="btn-slash" onclick="testBloodSlash()">ğŸ—¡ï¸ í˜ˆí” ìŠ¬ë˜ì‹œ</button>
            <button class="btn-dismember" onclick="testDismember()">âš”ï¸ ìˆ˜í‰ ì ˆë‹¨</button>
            <button class="btn-dismember" onclick="testVerticalDismember()">âš”ï¸ ìˆ˜ì§ ì ˆë‹¨</button>
            <button style="background:linear-gradient(135deg,#8b4513,#654321);color:#fff;" onclick="testDiagonalDismember()">â†—ï¸ ëŒ€ê°ì„  ì ˆë‹¨</button>
            <button style="background:linear-gradient(135deg,#ff6347,#dc143c);color:#fff;" onclick="testShatterDismember()">ğŸ’¥ ì¡°ê°ì¡°ê°</button>
            <button class="btn-explode" onclick="testExplodeDismember()">ğŸ’£ 4ì¡°ê° í­ë°œ</button>
            <button class="btn-explode" onclick="testRandomDismember()">ğŸ² ëœë¤ ì ˆë‹¨</button>
            <hr style="border-color:#666;margin:10px 0;">
            <button style="background:linear-gradient(135deg,#ff0,#f80);color:#000;" onclick="testForcedFragments('minor')">ğŸ’€ Minor íŒŒí¸</button>
            <button style="background:linear-gradient(135deg,#f80,#f00);color:#fff;" onclick="testForcedFragments('brutal')">ğŸ’€ Brutal íŒŒí¸</button>
            <button style="background:linear-gradient(135deg,#f00,#800);color:#fff;" onclick="testForcedFragments('obliterate')">â˜ ï¸ Obliterate íŒŒí¸</button>
        </div>
        <div style="margin-top:10px;font-size:11px;color:#888;">
            âš ï¸ file:// í”„ë¡œí† ì½œì—ì„œëŠ” ì´ë¯¸ì§€ ì ˆë‹¨ ë¶ˆê°€<br>
            â†’ íŒŒí¸ ë²„íŠ¼ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”!
        </div>
    </div>
    
    <div class="test-target" id="test-target">
        <img src="goblinarcher.png" alt="Test Target" id="target-img" 
             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22200%22><rect fill=%22%23444%22 width=%22150%22 height=%22200%22/><text x=%2275%22 y=%22100%22 fill=%22white%22 text-anchor=%22middle%22>Target</text></svg>'">
        <div class="label">ğŸ¹ Goblin Archer - í´ë¦­í•´ì„œ í…ŒìŠ¤íŠ¸</div>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        // ë¡œê·¸ í•¨ìˆ˜
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }
        
        // VFX ì‹œìŠ¤í…œ (ê°„ì†Œí™”)
        const VFX = {
            canvas: null,
            ctx: null,
            particles: [],
            animations: [],
            isRunning: false,
            timeScale: 1.0,
            
            init() {
                this.canvas = document.getElementById('vfx-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                log('VFX ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            },
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            
            ensureLoop() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.loop();
                }
            },
            
            loop() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const dt = 0.016 * this.timeScale;
                
                // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
                this.particles = this.particles.filter(p => {
                    if (!p.alive) return false;
                    if (typeof p.update === 'function') {
                        p.update(dt, this.timeScale);
                    }
                    if (p.alive && typeof p.draw === 'function') {
                        p.draw(this.ctx);
                    }
                    return p.alive;
                });
                
                // ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸
                this.animations = this.animations.filter(a => {
                    if (!a.alive) return false;
                    a._timeScale = this.timeScale;
                    if (typeof a.update === 'function') {
                        a.update();
                    }
                    if (a.alive && typeof a.draw === 'function') {
                        a.draw(this.ctx);
                    }
                    return a.alive;
                });
                
                // ê³„ì† ì‹¤í–‰
                if (this.particles.length > 0 || this.animations.length > 0) {
                    requestAnimationFrame(() => this.loop());
                } else {
                    this.isRunning = false;
                }
            }
        };
        
        // ì´ˆê¸°í™”
        VFX.init();
    </script>
    
    <!-- GoreVFX ë¡œë“œ -->
    <script src="gore-vfx.js"></script>
    
    <script>
        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        const target = document.getElementById('test-target');
        const targetImg = document.getElementById('target-img');
        
        function getTargetCenter() {
            const rect = target.getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2,
                width: rect.width,
                height: rect.height
            };
        }
        
        function testBloodSplatter() {
            const { x, y } = getTargetCenter();
            log('í”¼ íŠ€ê¹€ í…ŒìŠ¤íŠ¸...', 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.bloodSplatter(x, y, { count: 50, speed: 400, size: 10 });
                log('GoreVFX.bloodSplatter() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testBloodSlash() {
            const { x, y } = getTargetCenter();
            log('í˜ˆí” ìŠ¬ë˜ì‹œ í…ŒìŠ¤íŠ¸...', 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.bloodSlash(x, y, { length: 200, width: 30, duration: 500 });
                log('GoreVFX.bloodSlash() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testDismember() {
            const { x, y, width, height } = getTargetCenter();
            log('ìˆ˜í‰ ì ˆë‹¨ í…ŒìŠ¤íŠ¸ (ì´ë¯¸ì§€ ì—†ìŒ)...', 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.dismember(x, y, { width, height, duration: 2000 });
                log('GoreVFX.dismember() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testVerticalDismember() {
            const { x, y, width, height } = getTargetCenter();
            log('ìˆ˜ì§ ì ˆë‹¨ í…ŒìŠ¤íŠ¸...', 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.verticalDismember(x, y, { width, height, duration: 2000 });
                log('GoreVFX.verticalDismember() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testExplodeDismember() {
            const { x, y, width, height } = getTargetCenter();
            log('4ì¡°ê° í­ë°œ ì ˆë‹¨ í…ŒìŠ¤íŠ¸...', 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.explodeDismember(x, y, { size: Math.max(width, height) * 0.7, duration: 2000 });
                log('GoreVFX.explodeDismember() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testDiagonalDismember() {
            const { x, y, width, height } = getTargetCenter();
            const reverse = Math.random() < 0.5;
            log(`ëŒ€ê°ì„  ì ˆë‹¨ í…ŒìŠ¤íŠ¸ (${reverse ? 'â†™' : 'â†—'})...`, 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.diagonalDismember(x, y, { width, height, duration: 2000, reverse });
                log('GoreVFX.diagonalDismember() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testShatterDismember() {
            const { x, y, width, height } = getTargetCenter();
            log('ì¡°ê°ì¡°ê° ì ˆë‹¨ í…ŒìŠ¤íŠ¸ (6~8ì¡°ê°)...', 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.shatterDismember(x, y, { width, height, duration: 2500 });
                log('GoreVFX.shatterDismember() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testRandomDismember() {
            const { x, y, width, height } = getTargetCenter();
            log('ğŸ² ëœë¤ ì ˆë‹¨ í…ŒìŠ¤íŠ¸...', 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                GoreVFX.randomDismember(x, y, { width, height, duration: 2000 });
                log('GoreVFX.randomDismember() í˜¸ì¶œ ì™„ë£Œ', 'success');
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        function testWithImage() {
            const { x, y, width, height } = getTargetCenter();
            const imgSrc = targetImg.src;
            log('ì´ë¯¸ì§€ ì ˆë‹¨ í…ŒìŠ¤íŠ¸: ' + imgSrc, 'info');
            
            if (typeof GoreVFX !== 'undefined') {
                // ëœë¤ ì ˆë‹¨
                const rand = Math.random();
                if (rand < 0.33) {
                    GoreVFX.dismember(x, y, { width, height, duration: 2000, imgSrc });
                    log('ìˆ˜í‰ ì ˆë‹¨ (ì´ë¯¸ì§€)', 'success');
                } else if (rand < 0.66) {
                    GoreVFX.verticalDismember(x, y, { width, height, duration: 2000, imgSrc });
                    log('ìˆ˜ì§ ì ˆë‹¨ (ì´ë¯¸ì§€)', 'success');
                } else {
                    GoreVFX.explodeDismember(x, y, { size: Math.max(width, height) * 0.7, duration: 2000, imgSrc });
                    log('í­ë°œ ì ˆë‹¨ (ì´ë¯¸ì§€)', 'success');
                }
            } else {
                log('GoreVFXê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!', 'error');
            }
        }
        
        // ê°•ì œ íŒŒí¸ í…ŒìŠ¤íŠ¸ (CORS ë¬¸ì œ ì—†ìŒ!)
        function testForcedFragments(tier) {
            const { x, y, width, height } = getTargetCenter();
            const overkillDamage = tier === 'obliterate' ? 50 : tier === 'brutal' ? 20 : 5;
            
            log(`ğŸ©¸ ê°•ì œ íŒŒí¸ í…ŒìŠ¤íŠ¸ (${tier})...`, 'info');
            
            // í™”ë©´ í”Œë˜ì‹œ
            const flash = document.createElement('div');
            const colors = {
                minor: 'rgba(139, 0, 0, 0.3)',
                brutal: 'rgba(255, 0, 0, 0.6)',
                obliterate: 'rgba(255, 255, 255, 0.7)'
            };
            flash.style.cssText = `
                position: fixed; inset: 0;
                background: ${colors[tier] || 'rgba(255, 0, 0, 0.5)'};
                pointer-events: none; z-index: 99999;
                animation: goreFlash 0.3s ease-out forwards;
            `;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
            
            // í”¼ íŠ€ê¹€
            if (typeof GoreVFX !== 'undefined') {
                const counts = { minor: 30, brutal: 100, obliterate: 150 };
                GoreVFX.bloodSplatter(x, y, {
                    count: counts[tier] || 50,
                    speed: 400 + overkillDamage * 10,
                    size: 8 + overkillDamage * 0.2
                });
            }
            
            // íŒŒí¸ ìƒì„± (ì§ì ‘ VFXì— ì¶”ê°€)
            const configs = {
                minor:     { count: 2, speed: 800 },
                brutal:    { count: 4, speed: 1400 },
                obliterate:{ count: 4, speed: 1800 }
            };
            const config = configs[tier] || configs.minor;
            const fragmentCount = config.count;
            const baseSpeed = config.speed + overkillDamage * 10;
            const fragmentSize = Math.max(width, height) * 0.5;
            
            const directions = fragmentCount === 2 
                ? [{ dx: -1.5, dy: -0.8 }, { dx: 1.5, dy: 0.8 }]
                : [{ dx: -1.5, dy: -1 }, { dx: 1.5, dy: -1 }, { dx: -1.2, dy: 1 }, { dx: 1.2, dy: 1 }];
            
            directions.forEach((dir, i) => {
                setTimeout(() => {
                    const fragment = createTestFragment(x, y, dir, fragmentSize, baseSpeed, overkillDamage);
                    VFX.animations.push(fragment);
                    VFX.ensureLoop();
                }, i * 20);
            });
            
            // í”¼ ì›…ë©ì´
            setTimeout(() => {
                if (typeof GoreVFX !== 'undefined') {
                    GoreVFX.bloodPool(x, y + height/2 + 50, { size: 80 });
                }
            }, 500);
            
            log(`${fragmentCount}ê°œ íŒŒí¸ ìƒì„± ì™„ë£Œ! (ì†ë„: ${baseSpeed})`, 'success');
        }
        
        // í…ŒìŠ¤íŠ¸ìš© íŒŒí¸ ìƒì„± í•¨ìˆ˜
        function createTestFragment(x, y, dir, size, speed, overkillDamage) {
            const viewportH = window.innerHeight;
            
            return {
                x, y,
                vx: dir.dx * (speed + Math.random() * 400),
                vy: dir.dy * speed - 500 - Math.random() * 400,
                vr: (Math.random() - 0.5) * 20,
                rotation: Math.random() * Math.PI * 2,
                size,
                alpha: 1,
                startTime: Date.now(),
                duration: 4000,
                gravity: 300,
                groundY: viewportH - 50 + Math.random() * 30,
                bounceCount: 0,
                maxBounces: 4,
                color: `hsl(0, ${60 + Math.random() * 40}%, ${8 + Math.random() * 12}%)`,
                bloodTrail: [],
                alive: true,
                
                update() {
                    const elapsed = Date.now() - this.startTime;
                    const dt = 0.016;
                    
                    if (Math.random() < 0.3 && this.bloodTrail.length < 20) {
                        this.bloodTrail.push({ x: this.x, y: this.y, size: 3 + Math.random() * 5, alpha: 0.8 });
                    }
                    this.bloodTrail.forEach(b => b.alpha *= 0.98);
                    this.bloodTrail = this.bloodTrail.filter(b => b.alpha > 0.1);
                    
                    this.vy += this.gravity * dt;
                    this.x += this.vx * dt;
                    this.y += this.vy * dt;
                    this.rotation += this.vr * dt;
                    
                    if (this.y > this.groundY && this.bounceCount < this.maxBounces) {
                        this.bounceCount++;
                        this.y = this.groundY;
                        this.vy = -this.vy * 0.5;
                        this.vx *= 0.8;
                        this.vr *= 0.7;
                        if (typeof GoreVFX !== 'undefined') {
                            GoreVFX.bloodSplatter(this.x, this.y, { count: 5, speed: 100, size: 3 });
                        }
                    }
                    
                    this.vx *= 0.998;
                    const progress = elapsed / this.duration;
                    if (progress > 0.8) this.alpha = 1 - (progress - 0.8) / 0.2;
                    if (progress >= 1) this.alive = false;
                },
                
                draw(ctx) {
                    this.bloodTrail.forEach(b => {
                        ctx.save();
                        ctx.globalAlpha = b.alpha * 0.6;
                        ctx.fillStyle = '#8b0000';
                        ctx.beginPath();
                        ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    });
                    
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    ctx.globalAlpha = this.alpha;
                    
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
                    ctx.shadowBlur = 20;
                    ctx.shadowOffsetX = 8;
                    ctx.shadowOffsetY = 8;
                    
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    const points = 6 + Math.floor(Math.random() * 3);
                    for (let i = 0; i < points; i++) {
                        const angle = (i / points) * Math.PI * 2;
                        const r = this.size / 2 * (0.6 + Math.random() * 0.4);
                        const px = Math.cos(angle) * r;
                        const py = Math.sin(angle) * r;
                        if (i === 0) ctx.moveTo(px, py);
                        else ctx.lineTo(px, py);
                    }
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.shadowBlur = 0;
                    ctx.strokeStyle = '#ff2222';
                    ctx.lineWidth = 5;
                    ctx.stroke();
                    
                    ctx.fillStyle = '#aa0000';
                    ctx.beginPath();
                    ctx.ellipse(0, this.size/2 + 8, 10, 6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                }
            };
        }
        
        // íƒ€ê²Ÿ í´ë¦­ ì‹œ í…ŒìŠ¤íŠ¸
        target.addEventListener('click', () => {
            // file:// í”„ë¡œí† ì½œì´ë©´ ê°•ì œ íŒŒí¸, ì•„ë‹ˆë©´ ì´ë¯¸ì§€ ì ˆë‹¨
            if (window.location.protocol === 'file:') {
                testForcedFragments('brutal');
            } else {
                testWithImage();
            }
        });
        
        // GoreVFX ë¡œë“œ í™•ì¸
        setTimeout(() => {
            if (typeof GoreVFX !== 'undefined') {
                log('âœ… GoreVFX ë¡œë“œ ì™„ë£Œ!', 'success');
                log('VFX.canvas: ' + (VFX.canvas ? 'ìˆìŒ' : 'ì—†ìŒ'), 'info');
                log('VFX.animations: ' + VFX.animations.length, 'info');
                log('í”„ë¡œí† ì½œ: ' + window.location.protocol, 'info');
                if (window.location.protocol === 'file:') {
                    log('âš ï¸ file:// í”„ë¡œí† ì½œ - ì´ë¯¸ì§€ ì ˆë‹¨ ëŒ€ì‹  íŒŒí¸ ë²„íŠ¼ ì‚¬ìš©', 'info');
                }
            } else {
                log('âŒ GoreVFX ë¡œë“œ ì‹¤íŒ¨!', 'error');
            }
        }, 500);
    </script>
</body>
</html>

